"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const index_js_1 = require("./utils/index.js");
const stream_1 = require("stream");
const uuid_1 = require("uuid");
const s3Client = new client_s3_1.S3Client();
const dydbClient = new client_dynamodb_1.DynamoDBClient();
const handler = async (event) => {
    const { id, exclusiveStartKey, limit } = extractQueryParams(event);
    switch (event.httpMethod) {
        case "GET":
            if (id)
                return handleImageFetching(id);
            else
                return handleGetImages(exclusiveStartKey, limit);
        case "POST":
            if (event.body)
                return handleSaveImageToS3(event.body);
            else
                return (0, index_js_1.LambdaResponse)(400, index_js_1.IMAGE_SAVING_CANNOT_BE_PROCESSED);
        default:
            return (0, index_js_1.LambdaResponse)(405, index_js_1.METHOD_NOT_ALLOWED + event.httpMethod);
    }
};
exports.handler = handler;
const extractQueryParams = (event) => {
    const id = event.queryStringParameters?.id;
    const exclusiveStartKey = event.queryStringParameters?.exclusiveStartKey;
    const limit = event.queryStringParameters?.limit
        ? parseInt(event.queryStringParameters.limit)
        : undefined;
    return { id, exclusiveStartKey, limit };
};
const handleImageFetching = async (id) => {
    try {
        const command = new client_s3_1.GetObjectCommand({
            Bucket: process.env.BUCKET_NAME,
            Key: `${id}.png`,
        });
        const { Body } = await s3Client.send(command);
        if (Body) {
            const chunks = [];
            const stream = stream_1.Readable.from(Body);
            stream.on("data", (chunk) => {
                chunks.push(chunk);
            });
            const buffer = await new Promise((resolve, reject) => {
                stream.on("end", () => {
                    resolve(Buffer.concat(chunks));
                });
                stream.on("error", reject);
            });
            const base64Image = "data:image/png;base64," + buffer.toString("base64");
            return (0, index_js_1.LambdaResponse)(200, JSON.stringify(base64Image));
        }
        return (0, index_js_1.LambdaResponse)(404, index_js_1.IMAGE_NOT_FOUND_ERROR);
    }
    catch (error) {
        return (0, index_js_1.LambdaResponse)(500, index_js_1.IMAGE_FETCHING_ERROR);
    }
};
const handleGetImages = async (exclusiveStartKey, limit) => {
    try {
        const command = new client_dynamodb_1.ScanCommand({
            TableName: process.env.DYNAMO_DB_TABLE_NAME,
            ExclusiveStartKey: exclusiveStartKey
                ? { id: { S: exclusiveStartKey } }
                : undefined,
            Limit: limit || 5,
        });
        const response = await dydbClient.send(command);
        return (0, index_js_1.LambdaResponse)(200, JSON.stringify({
            items: response.Items,
            count: response.Count,
            lastEvaluatedKey: response.LastEvaluatedKey,
        }));
    }
    catch (error) {
        return (0, index_js_1.LambdaResponse)(500, index_js_1.DYNAMO_DB_GET_IMAGES_ERROR + error.message);
    }
};
const handleSaveImageToS3 = async (image) => {
    try {
        const imageBuffer = image ? Buffer.from(image, "base64") : null;
        if (!imageBuffer) {
            return (0, index_js_1.LambdaResponse)(400, index_js_1.IMAGE_SAVING_CANNOT_BE_PROCESSED);
        }
        const imageId = (0, uuid_1.v4)();
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: process.env.BUCKET_NAME,
            Key: `${imageId}.png`,
            Body: imageBuffer,
            ContentType: "image/png",
        }));
        return (0, index_js_1.LambdaResponse)(200, JSON.stringify(imageId));
    }
    catch (error) {
        return (0, index_js_1.LambdaResponse)(500, error.message);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW1hZ2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUk0QjtBQUU1Qiw4REFBdUU7QUFDdkUsK0NBUTBCO0FBQzFCLG1DQUFrQztBQUNsQywrQkFBb0M7QUFFcEMsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxFQUFFLENBQUM7QUFDaEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxnQ0FBYyxFQUFFLENBQUM7QUFFakMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUEyQixFQUNLLEVBQUU7SUFDbEMsTUFBTSxFQUFFLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUVuRSxRQUFRLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN6QixLQUFLLEtBQUs7WUFDUixJQUFJLEVBQUU7Z0JBQUUsT0FBTyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsQ0FBQzs7Z0JBQ2xDLE9BQU8sZUFBZSxDQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hELEtBQUssTUFBTTtZQUNULElBQUksS0FBSyxDQUFDLElBQUk7Z0JBQUUsT0FBTyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7O2dCQUNsRCxPQUFPLElBQUEseUJBQWMsRUFBQyxHQUFHLEVBQUUsMkNBQWdDLENBQUMsQ0FBQztRQUNwRTtZQUNFLE9BQU8sSUFBQSx5QkFBYyxFQUFDLEdBQUcsRUFBRSw2QkFBa0IsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdEUsQ0FBQztBQUNILENBQUMsQ0FBQztBQWZXLFFBQUEsT0FBTyxXQWVsQjtBQUVGLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxLQUEyQixFQUFFLEVBQUU7SUFDekQsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQztJQUMz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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBHZXRPYmplY3RDb21tYW5kLFxyXG4gIFB1dE9iamVjdENvbW1hbmQsXHJcbiAgUzNDbGllbnQsXHJcbn0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zM1wiO1xyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFNjYW5Db21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1keW5hbW9kYlwiO1xyXG5pbXBvcnQge1xyXG4gIERZTkFNT19EQl9HRVRfSU1BR0VTX0VSUk9SLFxyXG4gIElNQUdFX0ZFVENISU5HX0VSUk9SLFxyXG4gIElNQUdFX05PVF9GT1VORF9FUlJPUixcclxuICBJTUFHRV9TQVZFX0VSUk9SX1RPX1MzLFxyXG4gIElNQUdFX1NBVklOR19DQU5OT1RfQkVfUFJPQ0VTU0VELFxyXG4gIExhbWJkYVJlc3BvbnNlLFxyXG4gIE1FVEhPRF9OT1RfQUxMT1dFRCxcclxufSBmcm9tIFwiLi91dGlscy9pbmRleC5qc1wiO1xyXG5pbXBvcnQgeyBSZWFkYWJsZSB9IGZyb20gXCJzdHJlYW1cIjtcclxuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSBcInV1aWRcIjtcclxuXHJcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KCk7XHJcbmNvbnN0IGR5ZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoKTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxyXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xyXG4gIGNvbnN0IHsgaWQsIGV4Y2x1c2l2ZVN0YXJ0S2V5LCBsaW1pdCB9ID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKGV2ZW50KTtcclxuXHJcbiAgc3dpdGNoIChldmVudC5odHRwTWV0aG9kKSB7XHJcbiAgICBjYXNlIFwiR0VUXCI6XHJcbiAgICAgIGlmIChpZCkgcmV0dXJuIGhhbmRsZUltYWdlRmV0Y2hpbmcoaWQpO1xyXG4gICAgICBlbHNlIHJldHVybiBoYW5kbGVHZXRJbWFnZXMoZXhjbHVzaXZlU3RhcnRLZXksIGxpbWl0KTtcclxuICAgIGNhc2UgXCJQT1NUXCI6XHJcbiAgICAgIGlmIChldmVudC5ib2R5KSByZXR1cm4gaGFuZGxlU2F2ZUltYWdlVG9TMyhldmVudC5ib2R5KTtcclxuICAgICAgZWxzZSByZXR1cm4gTGFtYmRhUmVzcG9uc2UoNDAwLCBJTUFHRV9TQVZJTkdfQ0FOTk9UX0JFX1BST0NFU1NFRCk7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gTGFtYmRhUmVzcG9uc2UoNDA1LCBNRVRIT0RfTk9UX0FMTE9XRUQgKyBldmVudC5odHRwTWV0aG9kKTtcclxuICB9XHJcbn07XHJcblxyXG5jb25zdCBleHRyYWN0UXVlcnlQYXJhbXMgPSAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KSA9PiB7XHJcbiAgY29uc3QgaWQgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmlkO1xyXG4gIGNvbnN0IGV4Y2x1c2l2ZVN0YXJ0S2V5ID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPy5leGNsdXNpdmVTdGFydEtleTtcclxuICBjb25zdCBsaW1pdCA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycz8ubGltaXRcclxuICAgID8gcGFyc2VJbnQoZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmxpbWl0KVxyXG4gICAgOiB1bmRlZmluZWQ7XHJcblxyXG4gIHJldHVybiB7IGlkLCBleGNsdXNpdmVTdGFydEtleSwgbGltaXQgfTtcclxufTtcclxuXHJcbmNvbnN0IGhhbmRsZUltYWdlRmV0Y2hpbmcgPSBhc3luYyAoaWQ6IHN0cmluZykgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xyXG4gICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FLFxyXG4gICAgICBLZXk6IGAke2lkfS5wbmdgLFxyXG4gICAgfSk7XHJcbiAgICBjb25zdCB7IEJvZHkgfSA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcblxyXG4gICAgaWYgKEJvZHkpIHtcclxuICAgICAgY29uc3QgY2h1bmtzOiBCdWZmZXJbXSA9IFtdO1xyXG4gICAgICBjb25zdCBzdHJlYW0gPSBSZWFkYWJsZS5mcm9tKEJvZHkgYXMgQXN5bmNJdGVyYWJsZTxhbnk+KTtcclxuXHJcbiAgICAgIHN0cmVhbS5vbihcImRhdGFcIiwgKGNodW5rOiBCdWZmZXIpID0+IHtcclxuICAgICAgICBjaHVua3MucHVzaChjaHVuayk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgbmV3IFByb21pc2U8QnVmZmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgc3RyZWFtLm9uKFwiZW5kXCIsICgpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdChjaHVua3MpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzdHJlYW0ub24oXCJlcnJvclwiLCByZWplY3QpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IGJhc2U2NEltYWdlID0gXCJkYXRhOmltYWdlL3BuZztiYXNlNjQsXCIgKyBidWZmZXIudG9TdHJpbmcoXCJiYXNlNjRcIik7XHJcblxyXG4gICAgICByZXR1cm4gTGFtYmRhUmVzcG9uc2UoMjAwLCBKU09OLnN0cmluZ2lmeShiYXNlNjRJbWFnZSkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIExhbWJkYVJlc3BvbnNlKDQwNCwgSU1BR0VfTk9UX0ZPVU5EX0VSUk9SKTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgcmV0dXJuIExhbWJkYVJlc3BvbnNlKDUwMCwgSU1BR0VfRkVUQ0hJTkdfRVJST1IpO1xyXG4gIH1cclxufTtcclxuXHJcbmNvbnN0IGhhbmRsZUdldEltYWdlcyA9IGFzeW5jIChleGNsdXNpdmVTdGFydEtleT86IHN0cmluZywgbGltaXQ/OiBudW1iZXIpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XHJcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuRFlOQU1PX0RCX1RBQkxFX05BTUUsXHJcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBleGNsdXNpdmVTdGFydEtleVxyXG4gICAgICAgID8geyBpZDogeyBTOiBleGNsdXNpdmVTdGFydEtleSB9IH1cclxuICAgICAgICA6IHVuZGVmaW5lZCxcclxuICAgICAgTGltaXQ6IGxpbWl0IHx8IDUsXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGR5ZGJDbGllbnQuc2VuZChjb21tYW5kKTtcclxuICAgIHJldHVybiBMYW1iZGFSZXNwb25zZShcclxuICAgICAgMjAwLFxyXG4gICAgICBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgaXRlbXM6IHJlc3BvbnNlLkl0ZW1zLFxyXG4gICAgICAgIGNvdW50OiByZXNwb25zZS5Db3VudCxcclxuICAgICAgICBsYXN0RXZhbHVhdGVkS2V5OiByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5LFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgcmV0dXJuIExhbWJkYVJlc3BvbnNlKFxyXG4gICAgICA1MDAsXHJcbiAgICAgIERZTkFNT19EQl9HRVRfSU1BR0VTX0VSUk9SICsgKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlXHJcbiAgICApO1xyXG4gIH1cclxufTtcclxuXHJcbmNvbnN0IGhhbmRsZVNhdmVJbWFnZVRvUzMgPSBhc3luYyAoaW1hZ2U/OiBzdHJpbmcpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgaW1hZ2VCdWZmZXIgPSBpbWFnZSA/IEJ1ZmZlci5mcm9tKGltYWdlLCBcImJhc2U2NFwiKSA6IG51bGw7XHJcblxyXG4gICAgaWYgKCFpbWFnZUJ1ZmZlcikge1xyXG4gICAgICByZXR1cm4gTGFtYmRhUmVzcG9uc2UoNDAwLCBJTUFHRV9TQVZJTkdfQ0FOTk9UX0JFX1BST0NFU1NFRCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaW1hZ2VJZCA9IHV1aWR2NCgpO1xyXG5cclxuICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQoXHJcbiAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcclxuICAgICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FLFxyXG4gICAgICAgIEtleTogYCR7aW1hZ2VJZH0ucG5nYCxcclxuICAgICAgICBCb2R5OiBpbWFnZUJ1ZmZlcixcclxuICAgICAgICBDb250ZW50VHlwZTogXCJpbWFnZS9wbmdcIixcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIExhbWJkYVJlc3BvbnNlKDIwMCwgSlNPTi5zdHJpbmdpZnkoaW1hZ2VJZCkpO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICByZXR1cm4gTGFtYmRhUmVzcG9uc2UoNTAwLCAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UpO1xyXG4gIH1cclxufTtcclxuIl19